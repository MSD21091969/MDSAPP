# MDS Architecture Overview

The MDS architecture is designed as a modular, multi-agent system built on a core principle: a strict separation of concerns between the **definition**, **translation**, and **execution** of complex workflows. This paradigm allows for a highly flexible and extensible system where the core business logic is decoupled from the underlying execution platform.

The entire system is centered around the `Casefile` data object, which acts as the single source of truth for a given mission.

### Key Architectural Components

The MDS is composed of several interconnected components that work together to realize the Define, Translate, Execute pattern:

*   **Casefile:** The central data object, acting as the single source of truth for a given mission. It stores the mission definition, generated workflows, execution results, and event logs.
*   **Agents:**
    *   **`HQOrchestratorAgent`:** The master agent, responsible for driving the overall Define -> Translate -> Execute flow based on the `Casefile`'s state.
    *   **`ProcessorAgent`:** (DEFINE) Generates abstract `Workflow` blueprints from high-level missions.
    *   **`EngineerAgent`:** (DEFINE) Analyzes execution results to refine and create optimized `EngineeredWorkflow` blueprints.
    *   **`ExecutorAgent`:** (TRANSLATE) Takes abstract `Workflow` objects and prepares them for execution on a specific runtime (e.g., ADK).
    *   **`ChatAgent`:** Provides the conversational interface for direct user interaction.
*   **Managers:**
    *   **`CasefileManager`:** Handles CRUD operations and persistence for `Casefile` objects.
    *   **`WorkflowManager`:** Dispatches workflow-related tasks (like orchestration) to background workers.
    *   **`CommunicationManager`:** Manages communication flows and agent prompts.
    *   **`DatabaseManager`:** Provides the interface for interacting with the Firestore database.
*   **Tools:** Callable functions registered with a `ToolRegistry` that agents can use to perform specific actions (e.g., interacting with external APIs, logging, data manipulation).
*   **Asynchronous Task System:** Utilizes **Celery** and **Redis** to offload long-running agent orchestration tasks from the main API thread to background workers, ensuring responsiveness and scalability.



## The Core Architectural Pattern: Define, Translate, Execute

The MDS operates on a three-stage pipeline that takes a high-level mission and transforms it into a running process.

### 1. DEFINE: The Abstract Blueprint

*   **Actors:** The `ProcessorAgent` and `EngineerAgent`.
*   **Process:** These agents are the "architects." They apply business knowledge and machine learning to analyze a mission (defined in the `Casefile`'s STIX-inspired `Campaign` object) and produce a logical plan.
*   **Product:** The output is a `Workflow` object. This object is a **platform-agnostic interface**â€”a detailed, abstract blueprint. It contains a list of required `Elements` (agents, tools) and the `WorkflowDynamics`, a graph structure that defines the complex, time-dependent logic connecting them. This blueprint is pure data; it is not directly executable.

### 2. TRANSLATE: The Specialist Builder

*   **Actor:** A platform-specific **`Executor`** (e.g., an `ADK_Executor`).
*   **Process:** The `Executor` is the "specialist builder." Its sole responsibility is to take the abstract `Workflow` object and translate it into concrete, executable code for its specific target platform. The `ADK_Executor`, for example, knows how to parse the `WorkflowDynamics` graph and compose a corresponding, nested flow of ADK agents (`SequentialAgent`, `ParallelAgent`, custom conditional agents, etc.).
*   **Product:** A runnable agent flow, ready for execution by the target platform's runtime engine.

### 3. EXECUTE: The Runtime Engine

*   **Actor:** The target platform's runtime (e.g., the **Google ADK's Primary Event Loop**).
*   **Process:** The `Executor` hands off the translated agent flow to the runtime engine. This engine manages the entire asynchronous execution, including running agents, calling tools, handling state, and managing the event loop until the process is complete.
*   **Product:** A `WorkflowExecutionResult`, which is saved back to the `Casefile`, and any other artifacts generated by the workflow (e.g., `ResearchResult` objects).

This architecture ensures that the core logic of the system (the `Workflow` objects) can be defined independently of any execution environment, allowing for future flexibility and extensibility.